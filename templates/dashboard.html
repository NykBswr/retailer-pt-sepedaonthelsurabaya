{% extends 'base.html' %}
{% block content %}
<section class="h-full w-full items-center justify-center p-12">
    <div class="w-full h-auto flex justify-between items-center mt-14 mb-8">
        <h1
            class="bg-gradient-to-tl from-secondary to-primary bg-clip-text text-start text-[3vw] font-extrabold text-transparent">
            Dashboard
        </h1>
    </div>
    <div class="flex w-full h-full">
        <div class="flex mr-2 flex-col rounded-md p-8 w-1/2 h-[69vh] border-[5px] border-secondary">
            <h1
                class="mb-2 bg-gradient-to-tl from-secondary to-primary bg-clip-text text-start text-[2vw] font-extrabold text-transparent">
                Transaction History
            </h1>
            <div class="max-w-full max-h-full overflow-auto">
                <table class="w-max h-max table-auto">
                    <thead>
                        <tr>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mr-1 px-3 py-2 text-start">
                                    Transaction ID
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mr-1 px-3 py-2 text-start">
                                    User
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg text-start mx-1 px-3 py-2">
                                    Product
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg text-start mx-1 px-3 py-2">
                                    Quantity
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mx-1 px-3 py-2 text-start">
                                    Price (Per Quantity)
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mx-1 px-3 py-2 text-start">
                                    Total Quantity
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mx-1 px-3 py-2 text-start">
                                    Total Price
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mx-1 px-3 py-2 text-start">
                                    Date
                                </h1>
                            </th>
                            <th>
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg mx-1 px-3 py-2 text-start">
                                    Time
                                </h1>
                            </th>
                            <th class="w-[3.5vw]">
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg text-center ml-1 px-3 py-2">
                                    Edit
                                </h1>
                            </th>
                            <th class="w-[3.5vw]">
                                <h1
                                    class="bg-gradient-to-tl from-secondary to-primary text-white rounded-md text-lg text-center ml-1 px-3 py-2">
                                    Delete
                                </h1>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in purchases %}
                        {% set product_count = purchase['detailed_products']|length %}
                        {% for product in purchase['detailed_products'] %}
                        <tr>
                            {% if loop.index == 1 %}
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary
                                    text-white text-lg font-semibold my-1 mr-1 p-[2px]">
                                        <div
                                            class="h-full flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary outline-0 md:text-sm lg:text-base">
                                            <h1 class="w-full h-full flex justify-start items-center">
                                                {{ purchase['id'] }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary
                                    text-white text-lg font-semibold my-1 mr-1 p-[2px]">
                                        <div
                                            class="h-full flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary outline-0 md:text-sm lg:text-base">
                                            <h1 class="w-full h-full flex justify-start items-center">
                                                {{ purchase['user'] }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            {% endif %}

                            <td>
                                <div
                                    class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary text-white text-lg font-semibold mx-1 my-1 p-[2px]">
                                    <h1
                                        class="flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary md:text-sm lg:text-base">
                                        {{ product['name'] }}
                                    </h1>
                                </div>
                            </td>
                            <td>
                                <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary
                                    to-primary text-white text-lg font-semibold mx-1 my-1 p-[2px]">
                                    <h1
                                        class="flex justify-center rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary md:text-sm lg:text-base">
                                        {{ product['quantity'] }}
                                    </h1>
                                </div>
                            </td>
                            <td>
                                <div
                                    class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary text-white text-lg font-semibold mx-1 my-1 p-[2px]">
                                    <h1
                                        class="flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary md:text-sm lg:text-base">
                                        {{ product['price'] | currency }}
                                    </h1>
                                </div>
                            </td>

                            {% if loop.index == 1 %}
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary
                                    text-white text-lg font-semibold my-1 mx-1 p-[2px]">
                                        <div
                                            class="h-full flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary outline-0 md:text-sm lg:text-base">
                                            <h1 class="w-full h-full flex justify-center items-center">
                                                {{ purchase['total_items'] }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary
                                    text-white text-lg font-semibold my-1 mx-1 p-[2px]">
                                        <div
                                            class="h-full flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary outline-0 md:text-sm lg:text-base">
                                            <h1 class="w-full h-full flex justify-start items-center">
                                                {{ purchase['total_transaction_price'] | currency }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary
                                    text-white text-lg font-semibold my-1 mx-1 p-[2px]">
                                        <div
                                            class="h-full flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary outline-0 md:text-sm lg:text-base">
                                            <h1 class="w-full h-full flex justify-start items-center">
                                                {{ purchase['timestamp'].strftime('%Y-%m-%d') }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary
                                    text-white text-lg font-semibold my-1 mx-1 p-[2px]">
                                        <div
                                            class="h-full flex rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-primary outline-0 md:text-sm lg:text-base">
                                            <h1 class="w-full h-full flex justify-start items-center">
                                                {{ purchase['timestamp'].strftime('%H:%M:%S') }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td rowspan="{{ product_count }}">
                                <div
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div
                                        class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary text-primary hover:text-white text-lg font-semibold ml-1 my-1 p-[2px]">
                                        <button id="edit-transaction-{{ purchase['id'] }}"
                                            class="justify-center items-center w-full flex rounded-md border-0 bg-white px-1 py-2 outline-0 hover:bg-gradient-to-tl from-secondary to-primary text-primary hover:text-white ">
                                            <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                                width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                                <path fill-rule="evenodd"
                                                    d="M11.32 6.176H5c-1.105 0-2 .949-2 2.118v10.588C3 20.052 3.895 21 5 21h11c1.105 0 2-.948 2-2.118v-7.75l-3.914 4.144A2.46 2.46 0 0 1 12.81 16l-2.681.568c-1.75.37-3.292-1.263-2.942-3.115l.536-2.839c.097-.512.335-.983.684-1.352l2.914-3.086Z"
                                                    clip-rule="evenodd" />
                                                <path fill-rule="evenodd"
                                                    d="M19.846 4.318a2.148 2.148 0 0 0-.437-.692 2.014 2.014 0 0 0-.654-.463 1.92 1.92 0 0 0-1.544 0 2.014 2.014 0 0 0-.654.463l-.546.578 2.852 3.02.546-.579a2.14 2.14 0 0 0 .437-.692 2.244 2.244 0 0 0 0-1.635ZM17.45 8.721 14.597 5.7 9.82 10.76a.54.54 0 0 0-.137.27l-.536 2.84c-.07.37.239.696.588.622l2.682-.567a.492.492 0 0 0 .255-.145l4.778-5.06Z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td rowspan="{{ product_count }}">
                                <form action="{{ url_for('delete_transaction', transaction_id=purchase['id']) }}"
                                    method="POST"
                                    class="w-full h-full flex flex-col {% if product_count == 1 %} justify-center {% endif %}">
                                    <div
                                        class="cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary text-primary hover:text-white text-lg font-semibold ml-1 my-1 p-[2px]">
                                        <button id="delete-transaction-{{ purchase['id'] }}"
                                            class="justify-center items-center w-full flex rounded-md border-0 bg-white px-1 py-2 outline-0 hover:bg-gradient-to-tl from-secondary to-primary text-primary hover:text-white ">
                                            <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                                width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                                <path fill-rule="evenodd"
                                                    d="M8.586 2.586A2 2 0 0 1 10 2h4a2 2 0 0 1 2 2v2h3a1 1 0 1 1 0 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8a1 1 0 0 1 0-2h3V4a2 2 0 0 1 .586-1.414ZM10 6h4V4h-4v2Zm1 4a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Zm4 0a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </form>
                            </td>
                            {% endif %}
                        </tr>
                        <div id="modal-{{ purchase['id'] }}"
                            class="fixed hidden modal-container blur-background2 overflow-y-auto overflow-x-hidden top-0 right-0 left-0 z-[10001] justify-center items-center w-full md:inset-0 h-full">
                            <div class="w-full h-full flex justify-center items-center relative">
                                <div class="box-gradient-border-third p-8 rounded-lg w-[80vw] max-w-lg">
                                    <h2 class="text-xl font-bold mb-4">Edit Transaction</h2>
                                    <form method="POST"
                                        action="{{ url_for('edit_transaction', transaction_id=purchase['id']) }}">
                                        <div class="flex flex-col items-center justify-between mb-4">
                                            {% for product in purchase['detailed_products'] %}
                                            <div class="w-full">
                                                <label class="block text-primary mb-2"
                                                    for="quantity-{{ product['name'] }}">
                                                    {{ product['name'] }}
                                                </label>
                                                <div
                                                    class="mb-3 w-full cursor-pointer rounded-md bg-gradient-to-tl from-secondary to-primary p-[2px]">
                                                    <input
                                                        class="flex w-full rounded-md border-0 bg-white px-3 py-2 text-xs font-medium text-dark outline-0 placeholder:text-primary md:text-sm lg:text-base"
                                                        value="{{ product['quantity'] }}" min="1" type="number"
                                                        name="quantity-{{ product['name'] }}" autofocus required>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-4 w-full flex flex-row justify-end">
                                            <div class="cursor-pointer text-xl font-semibold bg-gradient-to-tl from-secondary to-primary text-white px-4 py-2 rounded-md hover:bg-red-500"
                                                id="cancel-{{ purchase['id'] }}">
                                                Cancel
                                            </div>
                                            <button
                                                class="text-xl font-semibold ml-2 bg-gradient-to-tl from-secondary to-primary text-white px-4 py-2 rounded-md hover:bg-primary"
                                                id="edit-{{ purchase['id'] }}">
                                                Edit
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <script>
                            document.getElementById("edit-transaction-{{ purchase['id'] }}").addEventListener('click',
                                function () {
                                    const modal = document.getElementById("modal-{{ purchase['id'] }}");
                                    modal.classList.remove('hidden');
                                    modal.classList.add('flex');
                                });

                            document.getElementById("cancel-{{ purchase['id'] }}").addEventListener('click',
                                function () {
                                    const modal = document.getElementById("modal-{{ purchase['id'] }}");
                                    modal.classList.remove('flex');
                                    modal.classList.add('hidden');
                                });
                        </script>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="flex ml-2 flex-col rounded-md p-8 w-1/2 overflow-y-auto h-[69vh] border-[5px] border-secondary">
            <div class="w-full h-full overflow-y-auto">
                <!-- Visualization -->
            </div>
        </div>
    </div>
    {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
    <div id="modal-1" class="modal-container blur-background overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-[10001]
        justify-center items-center w-full md:inset-0 h-full">
        <div class="w-full h-full flex justify-center items-center relative">
            <div
                class="{% if category == 'error' %} border-red-500 border-2 rounded-md sm:w-auto max-w-[80vw] sm:max-w-none {% else %} w-auto min-w-[60vw] max-w-[80vw] md:max-w-[65vw] {% endif %}">
                <div
                    class="relative rounded-md shadow {% if category == 'error' %} w-full h-full bg-red-50 {% else %} flex flex-col justify-center box-gradient-border-third p-3 {% endif %}">
                    <div
                        class="flex items-center justify-between border-b rounded-t {% if category == 'error' %} px-4 py-2 md:px-5 border-red-200 {% else %} p-4 md:p-5 {% endif %}">
                        <h3
                            class="font-bold {% if category == 'error' %} text-xs md:text-base lg:text-lg text-red-500 {% else %} text-sm md:text-lg lg:text-xl text-primary {% endif %}">
                            {% set category, message = messages[0] %}
                            {% if category == 'success' %}
                            Success
                            {% elif category == 'error' %}
                            Error
                            {% endif %}
                        </h3>
                        <button class="close-modal rounded-md text-sm w-8 h-8 ms-auto inline-flex justify-center
                            items-center {% if category == 'error' %}text-red-400 bg-transparent hover:bg-red-200
                            hover:text-red-900 {% else %} boxes-svg2 text-dark hover:text-white{% endif %}">
                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 14 14">
                                <path stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"
                                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                            </svg>
                            <span class="sr-only">Close modal</span>
                        </button>
                    </div>
                    <div class="{% if category == 'error' %} py-2 px-4 md:px-6 {% else %} p-4 md:p-6 {% endif %}">
                        <div class="w-full h-full flex justify-start items-center z-100">
                            {% for category, message in messages %}
                            <div
                                class="text-xl font-semibold mb-3 {% if category == 'success' %} text-green-600 {% elif category == 'error' %} text-red-600 {% endif %}">
                                {{ message }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Tambahkan event listener untuk menutup modal ketika tombol 'Close' diklik
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function () {
                const modalElement = document.getElementById('modal-1'); // Ambil modal by ID

                // Sembunyikan modal dengan menghapus elemen dari DOM atau menambah class 'hidden'
                if (modalElement) {
                    modalElement.classList.add('hidden');
                }
            });
        });
    </script>
    {% endif %}
    {% endwith %}
</section>
{% endblock %}